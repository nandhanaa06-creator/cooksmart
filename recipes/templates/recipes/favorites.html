{% extends 'recipes/base.html' %}
{% block content %}

<h4 class="fw-bold text-success mb-4 text-center">
    ‚ù§Ô∏è My Favorite Recipes
</h4>

<div class="row g-4">

{% for fav in favorites %}
<div class="col-lg-3 col-md-4 col-sm-6">

    <div class="card recipe-card shadow-sm h-100 position-relative">

        <!-- üîó CARD CLICK -->
        <a href="{% url 'recipe_detail' fav.recipe.id %}"
           class="stretched-link card-link"></a>

        <!-- ‚ù§Ô∏è FLOATING HEART (REMOVE) -->
        <button
            class="fav-btn-icon"
            data-id="{{ fav.recipe.id }}"
            onclick="removeFavorite(this, event)"
            title="Remove from favorites">
            ‚ù§Ô∏è
        </button>

        <!-- IMAGE -->
        {% if fav.recipe.image %}
        <img src="{{ fav.recipe.image.url }}"
             class="card-img-top recipe-img"
             alt="{{ fav.recipe.title }}">
        {% endif %}

        <!-- BODY -->
        <div class="card-body p-3 position-relative">

            <h6 class="fw-bold mb-1 text-truncate">
                {{ fav.recipe.title }}
            </h6>

            <p class="text-muted small mb-3">
                {{ fav.recipe.description|truncatechars:45 }}
            </p>

            <!-- REMOVE BUTTON (USER FRIENDLY) -->
            <button
                class="btn btn-danger-soft btn-sm w-100 remove-btn"
                data-id="{{ fav.recipe.id }}"
                onclick="removeFavorite(this, event)">
                ‚ù§Ô∏è Remove from Favorites
            </button>

        </div>
    </div>

</div>
{% empty %}
<p class="text-center text-muted mt-4">
    No favorite recipes yet ‚ù§Ô∏è
</p>
{% endfor %}

</div>

<!-- ================= STYLES ================= -->
<style>
.recipe-card {
    border-radius: 10px;
    overflow: hidden;
    transition: transform .15s ease;
}

.recipe-card:hover {
    transform: translateY(-4px);
}

.recipe-img {
    height: 170px;
    object-fit: cover;
}

/* stretched link under buttons */
.card-link {
    z-index: 1;
}

/* ‚ù§Ô∏è floating heart */
.fav-btn-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 5;

    width: 36px;
    height: 36px;
    border-radius: 50%;

    border: none;
    background: #fff;
    font-size: 18px;
    cursor: pointer;
    color: #e63946;

    display: flex;
    align-items: center;
    justify-content: center;

    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: transform .15s ease, background .15s ease;
}

.fav-btn-icon:hover {
    transform: scale(1.15);
    background: #ffecec;
}

/* ‚úÖ friendly remove button */
.btn-danger-soft {
    background: #ffecec;
    color: #d62828;
    border: none;
    font-weight: 500;
}

.btn-danger-soft:hover {
    background: #ffd6d6;
    color: #b91c1c;
}

/* keep button above link */
.remove-btn {
    position: relative;
    z-index: 5;
}
</style>

<!-- ================= SCRIPT ================= -->
<script>
function removeFavorite(btn, event) {
    event.preventDefault();
    event.stopPropagation();

    const recipeId = btn.dataset.id;

    fetch(`/recipe/${recipeId}/toggle-favorite/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "removed") {
            btn.closest(".col-lg-3, .col-md-4, .col-sm-6").remove();
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(';').forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
            );
        }
    });
    return cookieValue;
}
</script>

{% endblock %}
